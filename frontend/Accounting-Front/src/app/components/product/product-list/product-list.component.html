<div class="product-list-container p-4">
  <p-card>
    <ng-template pTemplate="header">
      <p-toolbar>
        <ng-template pTemplate="start">
          <h2 class="m-0">المنتجات</h2>
        </ng-template>
        <ng-template pTemplate="end">
          <p-button label="إضافة منتج جديد" icon="pi pi-plus" (click)="showDialog()" severity="success">
          </p-button>
        </ng-template>
      </p-toolbar>
    </ng-template>

    <p-dialog header="إضافة منتج" [(visible)]="visible" [modal]="true" [style]="{ width: '55rem' }"
      [breakpoints]="{ '960px': '95vw' }" [dismissableMask]="true" [blockScroll]="true">

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-fluid p-3 grid">


        <!-- ROW: Name -->
        <div class="field col-12 mb-4">
          <label for="name">اسم المنتج</label>
          <input id="name" pInputText formControlName="name"
            [ngClass]="{'p-invalid': form.get('name')?.invalid && form.get('name')?.touched}"
            class="w-full text-base" />
          <small *ngIf="form.get('name')?.invalid && form.get('name')?.touched" class="p-error" style="color: red;">اسم
            المنتج مطلوب</small>
        </div>

        <!-- ROW: Cost & CostPrice -->
        <div class="formgrid grid col-12 mb-4">
          <div class="field col-12 md:col-6 pr-2">
            <label for="cost">سعر البيع</label>
            <input id="cost" pInputText type="number" formControlName="cost"
              [ngClass]="{'p-invalid': form.get('cost')?.invalid && form.get('cost')?.touched}"
              class="w-full text-base" />
            <small *ngIf="form.get('cost')?.invalid && form.get('cost')?.touched" class="p-error"
              style="color: red;">السعر مطلوب</small>
          </div>

          <div class="field col-12 md:col-6 pl-2">
            <label for="costPrice">سعر الشراء</label>
            <input id="costPrice" pInputText type="number" formControlName="costPrice"
              [ngClass]="{'p-invalid': form.get('costPrice')?.invalid && form.get('costPrice')?.touched}"
              class="w-full text-base" />
            <small *ngIf="form.get('costPrice')?.invalid && form.get('costPrice')?.touched" class="p-error"
              style="color: red;">سعر الشراء مطلوب</small>
          </div>
        </div>

        <!-- ROW: Barcode -->
        <div class="field col-12 mb-4">
          <label for="barcode">الباركود</label>
          <input id="barcode" pInputText formControlName="barcode"
            [ngClass]="{'p-invalid': form.get('barcode')?.invalid && form.get('barcode')?.touched}"
            class="w-full text-base" />
          <small *ngIf="form.get('barcode')?.invalid && form.get('barcode')?.touched" class="p-error"
            style="color: red;">الباركود مطلوب</small>
        </div>

        <!-- ROW: Category, Color, Size -->
        <div class="formgrid grid col-12 mb-4">
          <div class="field col-12 md:col-4 pr-2">
            <label>الفئة</label>
            <p-select formControlName="productCategoryID" [options]="categories()" optionLabel="name" optionValue="id"
              placeholder="اختر الفئة" (onShow)="loadCategories()" [loading]="loadingCategory"
              [ngClass]="{'p-invalid': form.get('productCategoryID')?.invalid && form.get('productCategoryID')?.touched}"
              class="w-full text-base" />
            <small *ngIf="form.get('productCategoryID')?.invalid && form.get('productCategoryID')?.touched"
              class="p-error" style="color: red;">الفئة مطلوبة</small>
          </div>

          <div class="field col-12 md:col-4 px-2">
            <label>اللون</label>
            <p-select formControlName="productColorID" [options]="productColors()" optionLabel="name" optionValue="id"
              placeholder="اختر اللون" (onShow)="loadColors()" [loading]="loadingColor"
              [ngClass]="{'p-invalid': form.get('productColorID')?.invalid && form.get('productColorID')?.touched}"
              class="w-full text-base" />
            <small *ngIf="form.get('productColorID')?.invalid && form.get('productColorID')?.touched" class="p-error"
              style="color: red;">اللون مطلوب</small>
          </div>

          <div class="field col-12 md:col-4 pl-2">
            <label>الحجم</label>
            <p-select formControlName="productSizeID" [options]="productSizes()" optionLabel="name" optionValue="id"
              placeholder="اختر الحجم" [virtualScroll]="true" [virtualScrollItemSize]="1" (onShow)="loadSizes()"
              [loading]="loadingSize"
              [ngClass]="{'p-invalid': form.get('productSizeID')?.invalid && form.get('productSizeID')?.touched}"
              class="w-full text-base" [virtualScroll]="true" [virtualScrollItemSize]="10" [scrollHeight]="'9rem'" />

            <small *ngIf="form.get('productSizeID')?.invalid && form.get('productSizeID')?.touched" class="p-error"
              style="color: red;">الحجم مطلوب</small>
          </div>
        </div>
        <!-- Footer Buttons -->
        <div class="col-12 flex justify-end gap-2 mt-2">
          <button type="button" pButton label="إلغاء" icon="pi pi-times" class="p-button-secondary"
            (click)="closeDialog()"></button>
          <button type="submit" pButton label="حفظ" icon="pi pi-save" class="p-button-success"
            [disabled]="form.invalid"></button>
        </div>
      </form>
    </p-dialog>

    <div class="card-content">
      @if (loading()) {
      <div class="loading-container text-center p-6">
        <p-progressSpinner></p-progressSpinner>
        <p class="mt-3">جاري تحميل المنتجات...</p>
      </div>
      }

      @if (error()) {
      <p-message severity="error" [text]="error()!" class="mb-3">
      </p-message>
      <div class="text-center">
        <p-button label="إعادة المحاولة" icon="pi pi-refresh" (click)="loadProducts()" severity="secondary">
        </p-button>
      </div>
      }

      @if (!loading() && !error() && products().length === 0) {
      <div class="empty-state text-center p-6">
        <i class="pi pi-box text-6xl text-400 mb-3"></i>
        <h3 class="text-xl mb-3">لا توجد منتجات</h3>
        <p class="text-600 mb-4">لم يتم العثور على أي منتجات. ابدأ بإضافة منتج جديد.</p>
        <p-button label="إضافة أول منتج" icon="pi pi-plus" (onClick)="showDialog()" severity="success">
        </p-button>
      </div>
      }

      @if (!loading() && !error() && products().length > 0) {
      <p-table [value]="products()" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
        currentPageReportTemplate="عرض {first} إلى {last} من {totalRecords} منتج" [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-striped" [scrollable]="true" scrollHeight="600px">

        <ng-template pTemplate="header">
          <tr>
            <th>الرقم</th>
            <th>اسم المنتج</th>
            <th>الباركود</th>
            <th>التكلفة</th>
            <th>سعر البيع</th>
            <th>الفئة</th>
            <th>اللون</th>
            <th>الحجم</th>
            <th>الإجراءات</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product>
          <tr>
            <td>{{ product.id }}</td>
            <td>
              <div class="flex align-items-center gap-2">
                <i class="pi pi-box text-primary"></i>
                <span class="font-semibold">{{ product.name }}</span>
              </div>
            </td>
            <td>
              <p-tag [value]="product.barcode" severity="info"></p-tag>
            </td>
            <td>
              <span class="font-semibold text-green-600">{{ product.costPrice | currency:'USD':'symbol':'1.2-2'
                }}</span>
            </td>
            <td>
              <span class="font-semibold text-blue-600">{{ product.cost | currency:'USD':'symbol':'1.2-2' }}</span>
            </td>
            <td>
              <p-tag [value]="getCategoryName(product.productCategoryID)" severity="warning"></p-tag>
            </td>
            <td>
              <p-tag [value]="getColorName(product.productColorID)" severity="warning"></p-tag>
            </td>
            <td>
              <p-tag [value]="getSizeName(product.productSizeID)" severity="warning"></p-tag>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button icon="pi pi-pencil" (onClick)="editProduct(product)" severity="info" size="small"
                  pTooltip="تعديل" [outlined]="true">
                </p-button>
                <p-button icon="pi pi-trash" (click)="deleteProduct(product)" severity="danger" size="small"
                  pTooltip="حذف" [outlined]="true">
                </p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9" class="text-center p-4">
              لا توجد منتجات للعرض
            </td>
          </tr>
        </ng-template>
      </p-table>
      }
    </div>
  </p-card>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>